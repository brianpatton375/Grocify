<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultimate Grocery Price Matcher</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0; padding: 0;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fafafa;
    padding: 20px;
    color: #222;
  }
  header {
    text-align: center;
    margin-bottom: 25px;
  }
  h1 {
    font-size: 2.5em;
    margin-bottom: 5px;
  }
  h2 {
    margin-top: 20px;
    margin-bottom: 10px;
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    padding: 25px 30px 40px;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(0,0,0,0.08);
  }
  textarea, input[type="file"] {
    width: 100%;
    padding: 10px;
    font-size: 1em;
    margin-top: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
  }
  button {
    background-color: #28a745;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.1em;
    margin-top: 15px;
    transition: background-color 0.3s ease;
  }
  button:hover:not(:disabled) {
    background-color: #218838;
  }
  button:disabled {
    background-color: #9ac89e;
    cursor: not-allowed;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 10px 8px;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }
  th {
    background-color: #007bff;
    color: white;
    text-align: left;
  }
  td.price, td.qty, td.unit {
    text-align: right;
  }
  input.qty-input, input.weight-input, select.size-select {
    width: 70px;
    padding: 5px;
    font-size: 1em;
    text-align: right;
    border: 1px solid #bbb;
    border-radius: 4px;
    transition: border-color 0.3s ease;
  }
  input.qty-input:focus, input.weight-input:focus, select.size-select:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 6px #28a745;
  }
  .total-row {
    font-weight: 700;
    background-color: #f0f8ff;
  }
  .site-image {
    width: 100%;
    max-height: 180px;
    object-fit: contain;
    margin-bottom: 20px;
    border-radius: 8px;
    display: block;
  }
  .store-filter, .price-filter {
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  .coupon-section {
    margin-top: 25px;
    background: #e7f4e4;
    border: 1px solid #a0d468;
    padding: 15px;
    border-radius: 8px;
  }
  .coupon-section h3 {
    margin-bottom: 12px;
  }
  .recipe-section {
    margin-top: 30px;
  }
  label.inline {
    display: inline-block;
    margin-right: 10px;
  }
  #portionScale {
    width: 100%;
    margin-top: 10px;
  }
  #spendingChart {
    margin-top: 30px;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  .loading {
    font-style: italic;
    color: #666;
  }
  .alert {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    padding: 12px;
    border-radius: 6px;
    margin-top: 20px;
    color: #856404;
  }
</style>
</head>
<body>

<header>
  <h1>Ultimate Grocery Price Matcher</h1>
  <p>Enter your grocery list, upload recipes, scale portions, filter prices, and get coupon suggestions.</p>
</header>

<div class="container">

  <img src="Grocify(1).jpg" alt="Grocery" class="site-image" />

  <label for="groceryList"><strong>Grocery List (one item per line):</strong></label>
  <textarea id="groceryList" placeholder="e.g., chicken breast&#10;potato chips&#10;carrots"></textarea>
  <button id="compareBtn">Compare Prices</button>

  <div class="store-filter" style="display:none;">
    <label><input type="checkbox" checked class="store-checkbox" value="A" /> Store A</label>
    <label><input type="checkbox" checked class="store-checkbox" value="B" /> Store B</label>
    <label><input type="checkbox" checked class="store-checkbox" value="C" /> Store C</label>
  </div>

  <div class="price-filter" style="display:none; align-items: center;">
    <label for="priceRangeMin" class="inline">Min Price: $<span id="minPriceDisplay">0</span></label>
    <input type="range" id="priceRangeMin" min="0" max="20" value="0" step="0.1" />
    <label for="priceRangeMax" class="inline">Max Price: $<span id="maxPriceDisplay">20</span></label>
    <input type="range" id="priceRangeMax" min="0" max="20" value="20" step="0.1" />
  </div>

  <div class="results" id="results"></div>

  <div class="coupon-section" style="display:none;">
    <h3>Coupon & Deal Suggestions</h3>
    <ul id="couponList"></ul>
  </div>

  <div class="recipe-section">
    <h2>Recipe Upload & Portion Scaling</h2>
    <input type="file" id="recipeFile" accept=".json,.txt" />
    <p style="margin-top:6px; font-size:0.9em; color:#555;">
      Upload JSON or plain text recipe with ingredients line-by-line.<br />
      Example JSON format:
      <pre style="background:#eee;padding:6px;border-radius:4px;">{
  "ingredients": [
    "2 chicken breasts",
    "3 cups rice",
    "1 onion"
  ]
}</pre>
    </p>
    <label for="portionScale"><strong>Portion Scale: <span id="portionScaleValue">1.0</span>x</strong></label>
    <input type="range" id="portionScale" min="0.1" max="5" step="0.1" value="1" disabled />
    <button id="applyScaleBtn" disabled>Apply Portion Scale to Grocery List</button>
  </div>

  <canvas id="spendingChart" width="400" height="400" style="display:none;"></canvas>

</div>

<!-- Chart.js CDN for spending breakdown graph -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ============ UTILS ============

  // Detect category based on keywords
  function detectCategory(item) {
    const lower = item.toLowerCase();
    if (/(chicken|beef|pork|steak|meat|bacon|sausage|turkey|fish|salmon|shrimp)/.test(lower)) return 'meat';
    if (/(chip|snack|cracker|cookie|candy|popcorn|nuts|pretzel)/.test(lower)) return 'snack';
    if (/(carrot|potato|tomato|lettuce|onion|broccoli|pepper|cucumber|vegetable|spinach|celery)/.test(lower)) return 'vegetable';
    return 'other';
  }

  // Parse ingredient line to extract quantity, unit and item name
  function parseIngredientLine(line) {
    // Very simple parser: try to extract leading number + unit
    // Examples: "2 chicken breasts", "3 cups rice", "1 onion"
    const qtyMatch = line.match(/^(\d+(\.\d+)?)/);
    let qty = qtyMatch ? parseFloat(qtyMatch[1]) : 1;
    let rest = line.replace(/^(\d+(\.\d+)?)/, '').trim();

    // Check if rest starts with unit (cup, cups, tbsp, tsp, lb, oz, pieces)
    const unitMatch = rest.match(/^(cups?|tbsp|tsp|lb|oz|pieces|pcs|pack|package|slice|slices|piece|bunch)/i);
    let unit = unitMatch ? unitMatch[1].toLowerCase() : '';
    if(unit) {
      rest = rest.slice(unit.length).trim();
    }
    return {qty, unit, itemName: rest};
  }

  // Generate coupon/deal suggestions (simple demo)
  function generateCoupons(list) {
    const coupons = [];
    const lowerList = list.map(i => i.item.toLowerCase());
    if(lowerList.includes('chicken breast') || lowerList.includes('chicken breasts')) {
      coupons.push('10% off all chicken products at Store A');
    }
    if(lowerList.some(i => i.includes('potato chips'))) {
      coupons.push('Buy 1 Get 1 Free on Potato Chips at Store B');
    }
    if(lowerList.some(i => i.includes('carrot'))) {
      coupons.push('$1 off fresh carrots at Store C');
    }
    if(coupons.length === 0) {
      coupons.push('No coupons available right now.');
    }
    return coupons;
  }

  // Save to localStorage
  function saveToLocal(key, data) {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch(e) {
      // no-op
    }
  }

  // Load from localStorage
  function loadFromLocal(key) {
    try {
      return JSON.parse(localStorage.getItem(key));
    } catch(e) {
      return null;
    }
  }

  // Simulated store prices (base prices per item, will randomize)
  function generateBasePrices(itemName) {
    // base price depends on category heuristics and randomness
    const cat = detectCategory(itemName);
    let base = 0;
    switch(cat) {
      case 'meat': base = 5 + Math.random() * 5; break; // $5-$10 per lb or per piece
      case 'snack': base = 1 + Math.random() * 3; break; // $1-$4 per package
      case 'vegetable': base = 0.5 + Math.random() * 2; break; // $0.5-$2.5 per piece
      default: base = 1 + Math.random() * 4; break; // $1-$5 per unit
    }
    return {
      A: +(base * (0.9 + Math.random() * 0.2)).toFixed(2),
      B: +(base * (0.85 + Math.random() * 0.3)).toFixed(2),
      C: +(base * (0.8 + Math.random() * 0.4)).toFixed(2)
    };
  }

  // ============ MAIN APP ============

  const groceryListEl = document.getElementById('groceryList');
  const compareBtn = document.getElementById('compareBtn');
  const resultsDiv = document.getElementById('results');
  const couponSection = document.querySelector('.coupon-section');
  const couponList = document.getElementById('couponList');
  const storeCheckboxes = document.querySelectorAll('.store-checkbox');
  const storeFilterDiv = document.querySelector('.store-filter');
  const priceFilterDiv = document.querySelector('.price-filter');
  const priceRangeMin = document.getElementById('priceRangeMin');
  const priceRangeMax = document.getElementById('priceRangeMax');
  const minPriceDisplay = document.getElementById('minPriceDisplay');
  const maxPriceDisplay = document.getElementById('maxPriceDisplay');
  const recipeFileInput = document.getElementById('recipeFile');
  const portionScaleInput = document.getElementById('portionScale');
  const portionScaleValueSpan = document.getElementById('portionScaleValue');
  const applyScaleBtn = document.getElementById('applyScaleBtn');
  const spendingChartCanvas = document.getElementById('spendingChart');
  let spendingChart;

  let groceryData = [];
  let selectedStores = new Set(['A', 'B', 'C']);
  let portionScale = 1.0;

  // Update store filter checkboxes
  storeCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      if(cb.checked) selectedStores.add(cb.value);
      else selectedStores.delete(cb.value);
      renderTable();
      updateTotals();
    });
  });

  // Price filter slider events
  function clampPriceRange() {
    let minV = parseFloat(priceRangeMin.value);
    let maxV = parseFloat(priceRangeMax.value);
    if(maxV < minV) {
      if(event.target === priceRangeMin) priceRangeMax.value = minV;
      else priceRangeMin.value = maxV;
    }
    minPriceDisplay.textContent = priceRangeMin.value;
    maxPriceDisplay.textContent = priceRangeMax.value;
    renderTable();
    updateTotals();
  }
  priceRangeMin.addEventListener('input', clampPriceRange);
  priceRangeMax.addEventListener('input', clampPriceRange);

  // Generate grocery data from input text (or after applying scale)
  function generateGroceryData(inputLines, scale = 1) {
    const list = [];
    inputLines.forEach(line => {
      line = line.trim();
      if(!line) return;
      const cat = detectCategory(line);
      let prices = generateBasePrices(line);
      // Scale prices randomly to simulate variation between stores
      // For scaling quantities, qty handled later by user input
      list.push({item: line, category: cat, prices, qty: 1});
    });
    return list;
  }

  // Render table
  function renderTable() {
    if(groceryData.length === 0) {
      resultsDiv.innerHTML = '<p><em>No grocery items to display.</em></p>';
      couponSection.style.display = 'none';
      priceFilterDiv.style.display = 'none';
      storeFilterDiv.style.display = 'none';
      spendingChartCanvas.style.display = 'none';
      return;
    }

    // Show filters
    priceFilterDiv.style.display = 'flex';
    storeFilterDiv.style.display = 'flex';

    // Table header
    let html = `<table>
      <thead>
      <tr>
        <th>Item</th>
        <th>Category</th>
        <th>Quantity</th>`;

    ['A','B','C'].forEach(store => {
      if(selectedStores.has(store)) html += `<th class="store${store}">Price (${store})</th>`;
    });

    html += '</tr></thead><tbody>';

    // Filter items by price range in at least one selected store
    const minPrice = parseFloat(priceRangeMin.value);
    const maxPrice = parseFloat(priceRangeMax.value);

    groceryData.forEach((data, idx) => {
      const prices = data.prices;
      let visible = false;
      for(const store of selectedStores) {
        if(prices[store] >= minPrice && prices[store] <= maxPrice) {
          visible = true;
          break;
        }
      }
      if(!visible) return;

      // Quantity input based on category
      let qtyInputHTML = '';
      if(data.category === 'meat') {
        // weight input in lbs
        qtyInputHTML = `<input type="number" min="0" step="0.1" value="${data.qty}" class="weight-input qty-input" data-index="${idx}" /> lbs`;
      } else if(data.category === 'snack') {
        // number packages + size dropdown
        const size = data.size || 'medium';
        qtyInputHTML = `
          <input type="number" min="0" step="1" value="${data.qty}" class="qty-input" data-index="${idx}" style="width:50px" /> packages
          <select class="size-select" data-index="${idx}" aria-label="Package size">
            <option value="small" ${size === 'small' ? 'selected' : ''}>Small</option>
            <option value="medium" ${size === 'medium' ? 'selected' : ''}>Medium</option>
            <option value="large" ${size === 'large' ? 'selected' : ''}>Large</option>
          </select>
        `;
      } else if(data.category === 'vegetable') {
        // count pieces
        qtyInputHTML = `<input type="number" min="0" step="1" value="${data.qty}" class="qty-input" data-index="${idx}" /> pieces`;
      } else {
        // simple count
        qtyInputHTML = `<input type="number" min="0" step="1" value="${data.qty}" class="qty-input" data-index="${idx}" /> pcs`;
      }

      html += `<tr>
        <td>${data.item}</td>
        <td>${data.category}</td>
        <td>${qtyInputHTML}</td>`;

      ['A','B','C'].forEach(store => {
        if(selectedStores.has(store)) {
          html += `<td class="price store${store}">$${data.prices[store].toFixed(2)}</td>`;
        }
      });

      html += '</tr>';
    });

    // Total row
    html += `<tr class="total-row">
      <td colspan="2">Total Cost</td>
      <td></td>`;
    ['A','B','C'].forEach(store => {
      if(selectedStores.has(store)) {
        html += `<td class="total${store}">$0.00</td>`;
      }
    });
    html += '</tr></tbody></table>';

    resultsDiv.innerHTML = html;

    attachInputListeners();
  }

  // Attach input listeners for quantities and sizes
  function attachInputListeners() {
    const weightInputs = document.querySelectorAll('input.weight-input');
    weightInputs.forEach(input => {
      input.oninput = onQuantityChange;
    });
    const qtyInputs = document.querySelectorAll('input.qty-input');
    qtyInputs.forEach(input => {
      input.oninput = onQuantityChange;
    });
    const sizeSelects = document.querySelectorAll('select.size-select');
    sizeSelects.forEach(select => {
      select.onchange = onQuantityChange;
    });
  }

  // When quantity or size changes, update data model and totals
  function onQuantityChange(e) {
    const target = e.target;
    const idx = parseInt(target.dataset.index);
    if(isNaN(idx) || idx < 0 || idx >= groceryData.length) return;

    const data = groceryData[idx];

    if(data.category === 'meat') {
      // weight input
      const val = parseFloat(target.value);
      data.qty = isNaN(val) ? 0 : val;
    } else if(data.category === 'snack') {
      // quantity + size
      if(target.classList.contains('qty-input')) {
        const val = parseInt(target.value);
        data.qty = isNaN(val) ? 0 : val;
      } else if(target.classList.contains('size-select')) {
        data.size = target.value;
      }
    } else {
      // quantity input
      const val = parseInt(target.value);
      data.qty = isNaN(val) ? 0 : val;
    }
    updateTotals();
  }

  // Calculate and update total costs per store and update chart
  function updateTotals() {
    let totalA = 0, totalB = 0, totalC = 0;
    let spendingByCategory = {meat:0, snack:0, vegetable:0, other:0};

    groceryData.forEach(data => {
      // Calculate effective quantity
      let qty = 0;
      if(data.category === 'meat') {
        qty = data.qty || 0;
      } else if(data.category === 'snack') {
        // package size multipliers
        let sizeMultiplier = 1;
        if(data.size === 'small') sizeMultiplier = 0.75;
        else if(data.size === 'medium') sizeMultiplier = 1;
        else if(data.size === 'large') sizeMultiplier = 1.5;
        qty = (data.qty || 0) * sizeMultiplier;
      } else {
        qty = data.qty || 0;
      }

      // Calculate totals only for selected stores
      if(selectedStores.has('A')) totalA += data.prices.A * qty;
      if(selectedStores.has('B')) totalB += data.prices.B * qty;
      if(selectedStores.has('C')) totalC += data.prices.C * qty;

      // Accumulate for chart
      if(spendingByCategory[data.category]) spendingByCategory[data.category] += data.prices.A * qty;
      else spendingByCategory.other += data.prices.A * qty;
    });

    // Update total prices in table
    if(selectedStores.has('A')) document.querySelector('.totalA').textContent = '$' + totalA.toFixed(2);
    if(selectedStores.has('B')) document.querySelector('.totalB').textContent = '$' + totalB.toFixed(2);
    if(selectedStores.has('C')) document.querySelector('.totalC').textContent = '$' + totalC.toFixed(2);

    // Show coupons
    couponSection.style.display = 'block';
    couponList.innerHTML = '';
    const coupons = generateCoupons(groceryData);
    coupons.forEach(c => {
      const li = document.createElement('li');
      li.textContent = c;
      couponList.appendChild(li);
    });

    // Update spending chart
    updateSpendingChart(spendingByCategory);
  }

  // Render spending breakdown chart
  function updateSpendingChart(data) {
    spendingChartCanvas.style.display = 'block';
    const categories = Object.keys(data);
    const values = categories.map(cat => +data[cat].toFixed(2));

    if(spendingChart) {
      spendingChart.data.labels = categories;
      spendingChart.data.datasets[0].data = values;
      spendingChart.update();
      return;
    }

    spendingChart = new Chart(spendingChartCanvas.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: categories,
        datasets: [{
          label: 'Spending Breakdown',
          data: values,
          backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#AA66CC']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {position: 'bottom'}
        }
      }
    });
  }

  // Recipe file upload and parsing
  recipeFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      const text = ev.target.result;
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      groceryData = generateGroceryData(lines, portionScale);
      renderTable();
      updateTotals();
    };
    reader.readAsText(file);
  });

  // Portion scale input
  portionScaleInput.addEventListener('input', (e) => {
    portionScale = parseFloat(e.target.value);
    portionScaleValueSpan.textContent = portionScale.toFixed(1);
  });

  // Apply portion scale button
  applyScaleBtn.addEventListener('click', () => {
    // Rescale quantities
    groceryData.forEach(d => {
      d.qty *= portionScale;
    });
    renderTable();
    updateTotals();
  });

  // Compare button
  compareBtn.addEventListener('click', () => {
    const text = groceryListEl.value.trim();
    if(!text) return alert('Please enter grocery items, one per line.');
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    groceryData = generateGroceryData(lines, portionScale);
    renderTable();
    updateTotals();
  });

  // Load saved data on page load
  window.onload = () => {
    const saved = loadFromLocal('groceryListData');
    if(saved && Array.isArray(saved) && saved.length > 0) {
      groceryData = saved;
      renderTable();
      updateTotals();
    }
  };

  // Save data before unload
  window.onbeforeunload = () => {
    saveToLocal('groceryListData', groceryData);
  };

})();  
</script>

</body>
</html>
